<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class Concurrent::ThreadSafe::Util::Striped64 - concurrent-ruby-1.0.2 Documentation</title>

<link type="text/css" media="screen" href="../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
</script>

<script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../../../index.html">Home</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  

  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/concurrent/thread_safe/util/striped64.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    
    <!-- Extension Modules -->
<nav id="extends-section" class="section">
  <h3 class="section-header">Extended With Modules</h3>

  <ul class="link-list">
    
  
    <li><a class="extend" href="Volatile.html">Concurrent::ThreadSafe::Util::Volatile</a>
  
  
  </ul>
</nav>

    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-cas_base_computed">#cas_base_computed</a>
    
    <li ><a href="#method-i-expand_table_unless_stale">#expand_table_unless_stale</a>
    
    <li ><a href="#method-i-free-3F">#free?</a>
    
    <li ><a href="#method-i-hash_code">#hash_code</a>
    
    <li ><a href="#method-i-hash_code-3D">#hash_code=</a>
    
    <li ><a href="#method-i-internal_reset">#internal_reset</a>
    
    <li ><a href="#method-i-retry_update">#retry_update</a>
    
    <li ><a href="#method-i-try_in_busy">#try_in_busy</a>
    
    <li ><a href="#method-i-try_initialize_cells">#try_initialize_cells</a>
    
    <li ><a href="#method-i-try_to_install_new_cell">#try_to_install_new_cell</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../../../CHANGELOG_md.html">CHANGELOG</a>
  
    <li class="file"><a href="../../../LICENSE_txt.html">LICENSE</a>
  
    <li class="file"><a href="../../../README_md.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../../../Concurrent.html">Concurrent</a>
  
    <li><a href="../../../Concurrent/AbstractExchanger.html">Concurrent::AbstractExchanger</a>
  
    <li><a href="../../../Concurrent/AbstractExecutorService.html">Concurrent::AbstractExecutorService</a>
  
    <li><a href="../../../Concurrent/AbstractThreadLocalVar.html">Concurrent::AbstractThreadLocalVar</a>
  
    <li><a href="../../../Concurrent/Agent.html">Concurrent::Agent</a>
  
    <li><a href="../../../Concurrent/Agent/Error.html">Concurrent::Agent::Error</a>
  
    <li><a href="../../../Concurrent/Agent/ValidationError.html">Concurrent::Agent::ValidationError</a>
  
    <li><a href="../../../Concurrent/Array.html">Concurrent::Array</a>
  
    <li><a href="../../../Concurrent/Async.html">Concurrent::Async</a>
  
    <li><a href="../../../Concurrent/Async/AsyncDelegator.html">Concurrent::Async::AsyncDelegator</a>
  
    <li><a href="../../../Concurrent/Async/AwaitDelegator.html">Concurrent::Async::AwaitDelegator</a>
  
    <li><a href="../../../Concurrent/Async/ClassMethods.html">Concurrent::Async::ClassMethods</a>
  
    <li><a href="../../../Concurrent/AtExitImplementation.html">Concurrent::AtExitImplementation</a>
  
    <li><a href="../../../Concurrent/Atom.html">Concurrent::Atom</a>
  
    <li><a href="../../../Concurrent/AtomicBoolean.html">Concurrent::AtomicBoolean</a>
  
    <li><a href="../../../Concurrent/AtomicDirectUpdate.html">Concurrent::AtomicDirectUpdate</a>
  
    <li><a href="../../../Concurrent/AtomicFixnum.html">Concurrent::AtomicFixnum</a>
  
    <li><a href="../../../Concurrent/AtomicNumericCompareAndSetWrapper.html">Concurrent::AtomicNumericCompareAndSetWrapper</a>
  
    <li><a href="../../../Concurrent/AtomicReference.html">Concurrent::AtomicReference</a>
  
    <li><a href="../../../Concurrent/CAtomicReference.html">Concurrent::CAtomicReference</a>
  
    <li><a href="../../../Concurrent/CachedThreadPool.html">Concurrent::CachedThreadPool</a>
  
    <li><a href="../../../Concurrent/Collection.html">Concurrent::Collection</a>
  
    <li><a href="../../../Concurrent/Collection/AtomicReferenceMapBackend.html">Concurrent::Collection::AtomicReferenceMapBackend</a>
  
    <li><a href="../../../Concurrent/Collection/AtomicReferenceMapBackend/Node.html">Concurrent::Collection::AtomicReferenceMapBackend::Node</a>
  
    <li><a href="../../../Concurrent/Collection/AtomicReferenceMapBackend/Table.html">Concurrent::Collection::AtomicReferenceMapBackend::Table</a>
  
    <li><a href="../../../Concurrent/Collection/CopyOnNotifyObserverSet.html">Concurrent::Collection::CopyOnNotifyObserverSet</a>
  
    <li><a href="../../../Concurrent/Collection/CopyOnWriteObserverSet.html">Concurrent::Collection::CopyOnWriteObserverSet</a>
  
    <li><a href="../../../Concurrent/Collection/JavaNonConcurrentPriorityQueue.html">Concurrent::Collection::JavaNonConcurrentPriorityQueue</a>
  
    <li><a href="../../../Concurrent/Collection/MriMapBackend.html">Concurrent::Collection::MriMapBackend</a>
  
    <li><a href="../../../Concurrent/Collection/NonConcurrentMapBackend.html">Concurrent::Collection::NonConcurrentMapBackend</a>
  
    <li><a href="../../../Concurrent/Collection/NonConcurrentPriorityQueue.html">Concurrent::Collection::NonConcurrentPriorityQueue</a>
  
    <li><a href="../../../Concurrent/Collection/RubyNonConcurrentPriorityQueue.html">Concurrent::Collection::RubyNonConcurrentPriorityQueue</a>
  
    <li><a href="../../../Concurrent/Collection/SynchronizedMapBackend.html">Concurrent::Collection::SynchronizedMapBackend</a>
  
    <li><a href="../../../Concurrent/Concern.html">Concurrent::Concern</a>
  
    <li><a href="../../../Concurrent/Concern/Deprecation.html">Concurrent::Concern::Deprecation</a>
  
    <li><a href="../../../Concurrent/Concern/Dereferenceable.html">Concurrent::Concern::Dereferenceable</a>
  
    <li><a href="../../../Concurrent/Concern/Logging.html">Concurrent::Concern::Logging</a>
  
    <li><a href="../../../Concurrent/Concern/Obligation.html">Concurrent::Concern::Obligation</a>
  
    <li><a href="../../../Concurrent/Concern/Observable.html">Concurrent::Concern::Observable</a>
  
    <li><a href="../../../Concurrent/ConcurrentUpdateError.html">Concurrent::ConcurrentUpdateError</a>
  
    <li><a href="../../../Concurrent/CountDownLatch.html">Concurrent::CountDownLatch</a>
  
    <li><a href="../../../Concurrent/CyclicBarrier.html">Concurrent::CyclicBarrier</a>
  
    <li><a href="../../../Concurrent/Delay.html">Concurrent::Delay</a>
  
    <li><a href="../../../Concurrent/DependencyCounter.html">Concurrent::DependencyCounter</a>
  
    <li><a href="../../../Concurrent/Edge.html">Concurrent::Edge</a>
  
    <li><a href="../../../Concurrent/Event.html">Concurrent::Event</a>
  
    <li><a href="../../../Concurrent/Exchanger.html">Concurrent::Exchanger</a>
  
    <li><a href="../../../Concurrent/ExecutorService.html">Concurrent::ExecutorService</a>
  
    <li><a href="../../../Concurrent/FixedThreadPool.html">Concurrent::FixedThreadPool</a>
  
    <li><a href="../../../Concurrent/Future.html">Concurrent::Future</a>
  
    <li><a href="../../../Concurrent/Hash.html">Concurrent::Hash</a>
  
    <li><a href="../../../Concurrent/IVar.html">Concurrent::IVar</a>
  
    <li><a href="../../../Concurrent/ImmediateExecutor.html">Concurrent::ImmediateExecutor</a>
  
    <li><a href="../../../Concurrent/ImmutableStruct.html">Concurrent::ImmutableStruct</a>
  
    <li><a href="../../../Concurrent/IndirectImmediateExecutor.html">Concurrent::IndirectImmediateExecutor</a>
  
    <li><a href="../../../Concurrent/JavaAtomicReference.html">Concurrent::JavaAtomicReference</a>
  
    <li><a href="../../../Concurrent/JavaCountDownLatch.html">Concurrent::JavaCountDownLatch</a>
  
    <li><a href="../../../Concurrent/JavaExchanger.html">Concurrent::JavaExchanger</a>
  
    <li><a href="../../../Concurrent/JavaExecutorService.html">Concurrent::JavaExecutorService</a>
  
    <li><a href="../../../Concurrent/JavaExecutorService/Job.html">Concurrent::JavaExecutorService::Job</a>
  
    <li><a href="../../../Concurrent/JavaSingleThreadExecutor.html">Concurrent::JavaSingleThreadExecutor</a>
  
    <li><a href="../../../Concurrent/JavaThreadLocalVar.html">Concurrent::JavaThreadLocalVar</a>
  
    <li><a href="../../../Concurrent/JavaThreadPoolExecutor.html">Concurrent::JavaThreadPoolExecutor</a>
  
    <li><a href="../../../Concurrent/LazyRegister.html">Concurrent::LazyRegister</a>
  
    <li><a href="../../../Concurrent/MVar.html">Concurrent::MVar</a>
  
    <li><a href="../../../Concurrent/Map.html">Concurrent::Map</a>
  
    <li><a href="../../../Concurrent/Maybe.html">Concurrent::Maybe</a>
  
    <li><a href="../../../Concurrent/MutableStruct.html">Concurrent::MutableStruct</a>
  
    <li><a href="../../../Concurrent/MutexAtomicBoolean.html">Concurrent::MutexAtomicBoolean</a>
  
    <li><a href="../../../Concurrent/MutexAtomicFixnum.html">Concurrent::MutexAtomicFixnum</a>
  
    <li><a href="../../../Concurrent/MutexAtomicReference.html">Concurrent::MutexAtomicReference</a>
  
    <li><a href="../../../Concurrent/MutexCountDownLatch.html">Concurrent::MutexCountDownLatch</a>
  
    <li><a href="../../../Concurrent/MutexSemaphore.html">Concurrent::MutexSemaphore</a>
  
    <li><a href="../../../Concurrent/Options.html">Concurrent::Options</a>
  
    <li><a href="../../../Concurrent/Process.html">Concurrent::Process</a>
  
    <li><a href="../../../Concurrent/Promise.html">Concurrent::Promise</a>
  
    <li><a href="../../../Concurrent/RbxAtomicReference.html">Concurrent::RbxAtomicReference</a>
  
    <li><a href="../../../Concurrent/ReadWriteLock.html">Concurrent::ReadWriteLock</a>
  
    <li><a href="../../../Concurrent/ReentrantReadWriteLock.html">Concurrent::ReentrantReadWriteLock</a>
  
    <li><a href="../../../Concurrent/RubyExchanger.html">Concurrent::RubyExchanger</a>
  
    <li><a href="../../../Concurrent/RubyExchanger/Node.html">Concurrent::RubyExchanger::Node</a>
  
    <li><a href="../../../Concurrent/RubyExecutorService.html">Concurrent::RubyExecutorService</a>
  
    <li><a href="../../../Concurrent/RubySingleThreadExecutor.html">Concurrent::RubySingleThreadExecutor</a>
  
    <li><a href="../../../Concurrent/RubyThreadLocalVar.html">Concurrent::RubyThreadLocalVar</a>
  
    <li><a href="../../../Concurrent/RubyThreadPoolExecutor.html">Concurrent::RubyThreadPoolExecutor</a>
  
    <li><a href="../../../Concurrent/RubyThreadPoolExecutor/Worker.html">Concurrent::RubyThreadPoolExecutor::Worker</a>
  
    <li><a href="../../../Concurrent/SafeTaskExecutor.html">Concurrent::SafeTaskExecutor</a>
  
    <li><a href="../../../Concurrent/ScheduledTask.html">Concurrent::ScheduledTask</a>
  
    <li><a href="../../../Concurrent/Semaphore.html">Concurrent::Semaphore</a>
  
    <li><a href="../../../Concurrent/SerialExecutorService.html">Concurrent::SerialExecutorService</a>
  
    <li><a href="../../../Concurrent/SerializedExecution.html">Concurrent::SerializedExecution</a>
  
    <li><a href="../../../Concurrent/SerializedExecutionDelegator.html">Concurrent::SerializedExecutionDelegator</a>
  
    <li><a href="../../../Concurrent/SettableStruct.html">Concurrent::SettableStruct</a>
  
    <li><a href="../../../Concurrent/SimpleExecutorService.html">Concurrent::SimpleExecutorService</a>
  
    <li><a href="../../../Concurrent/SingleThreadExecutor.html">Concurrent::SingleThreadExecutor</a>
  
    <li><a href="../../../Concurrent/Synchronization.html">Concurrent::Synchronization</a>
  
    <li><a href="../../../Concurrent/Synchronization/AbstractLockableObject.html">Concurrent::Synchronization::AbstractLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/AbstractObject.html">Concurrent::Synchronization::AbstractObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/AbstractStruct.html">Concurrent::Synchronization::AbstractStruct</a>
  
    <li><a href="../../../Concurrent/Synchronization/Condition.html">Concurrent::Synchronization::Condition</a>
  
    <li><a href="../../../Concurrent/Synchronization/JRubyAttrVolatile.html">Concurrent::Synchronization::JRubyAttrVolatile</a>
  
    <li><a href="../../../Concurrent/Synchronization/JRubyAttrVolatile/ClassMethods.html">Concurrent::Synchronization::JRubyAttrVolatile::ClassMethods</a>
  
    <li><a href="../../../Concurrent/Synchronization/JRubyLockableObject.html">Concurrent::Synchronization::JRubyLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/JRubyObject.html">Concurrent::Synchronization::JRubyObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/Lock.html">Concurrent::Synchronization::Lock</a>
  
    <li><a href="../../../Concurrent/Synchronization/LockableObject.html">Concurrent::Synchronization::LockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriAttrVolatile.html">Concurrent::Synchronization::MriAttrVolatile</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriAttrVolatile/ClassMethods.html">Concurrent::Synchronization::MriAttrVolatile::ClassMethods</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriLockableObject.html">Concurrent::Synchronization::MriLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriMonitorLockableObject.html">Concurrent::Synchronization::MriMonitorLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriMutexLockableObject.html">Concurrent::Synchronization::MriMutexLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/MriObject.html">Concurrent::Synchronization::MriObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/Object.html">Concurrent::Synchronization::Object</a>
  
    <li><a href="../../../Concurrent/Synchronization/RbxAttrVolatile.html">Concurrent::Synchronization::RbxAttrVolatile</a>
  
    <li><a href="../../../Concurrent/Synchronization/RbxAttrVolatile/ClassMethods.html">Concurrent::Synchronization::RbxAttrVolatile::ClassMethods</a>
  
    <li><a href="../../../Concurrent/Synchronization/RbxLockableObject.html">Concurrent::Synchronization::RbxLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/RbxObject.html">Concurrent::Synchronization::RbxObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/TruffleAttrVolatile.html">Concurrent::Synchronization::TruffleAttrVolatile</a>
  
    <li><a href="../../../Concurrent/Synchronization/TruffleAttrVolatile/ClassMethods.html">Concurrent::Synchronization::TruffleAttrVolatile::ClassMethods</a>
  
    <li><a href="../../../Concurrent/Synchronization/TruffleLockableObject.html">Concurrent::Synchronization::TruffleLockableObject</a>
  
    <li><a href="../../../Concurrent/Synchronization/TruffleObject.html">Concurrent::Synchronization::TruffleObject</a>
  
    <li><a href="../../../Concurrent/SynchronizedDelegator.html">Concurrent::SynchronizedDelegator</a>
  
    <li><a href="../../../Concurrent/TVar.html">Concurrent::TVar</a>
  
    <li><a href="../../../Concurrent/ThreadLocalVar.html">Concurrent::ThreadLocalVar</a>
  
    <li><a href="../../../Concurrent/ThreadPoolExecutor.html">Concurrent::ThreadPoolExecutor</a>
  
    <li><a href="../../../Concurrent/ThreadSafe.html">Concurrent::ThreadSafe</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util.html">Concurrent::ThreadSafe::Util</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/Adder.html">Concurrent::ThreadSafe::Util::Adder</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/CheapLockable.html">Concurrent::ThreadSafe::Util::CheapLockable</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/PowerOfTwoTuple.html">Concurrent::ThreadSafe::Util::PowerOfTwoTuple</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/Striped64.html">Concurrent::ThreadSafe::Util::Striped64</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/Striped64/Cell.html">Concurrent::ThreadSafe::Util::Striped64::Cell</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/Volatile.html">Concurrent::ThreadSafe::Util::Volatile</a>
  
    <li><a href="../../../Concurrent/ThreadSafe/Util/XorShiftRandom.html">Concurrent::ThreadSafe::Util::XorShiftRandom</a>
  
    <li><a href="../../../Concurrent/TimerSet.html">Concurrent::TimerSet</a>
  
    <li><a href="../../../Concurrent/TimerTask.html">Concurrent::TimerTask</a>
  
    <li><a href="../../../Concurrent/Transaction.html">Concurrent::Transaction</a>
  
    <li><a href="../../../Concurrent/Tuple.html">Concurrent::Tuple</a>
  
    <li><a href="../../../Concurrent/Utility.html">Concurrent::Utility</a>
  
    <li><a href="../../../Concurrent/Utility/EngineDetector.html">Concurrent::Utility::EngineDetector</a>
  
    <li><a href="../../../Concurrent/Utility/NativeExtensionLoader.html">Concurrent::Utility::NativeExtensionLoader</a>
  
    <li><a href="../../../Concurrent/Utility/ProcessorCounter.html">Concurrent::Utility::ProcessorCounter</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Concurrent::ThreadSafe::Util::Striped64</h1>

  <div id="description" class="description">
    
<p>A Ruby port of the Doug Lea&#39;s jsr166e.Striped64 class version 1.6
available in public domain.</p>

<p>Original source code available here: <a
href="http://gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/Striped64.java?revision=1.6">gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/jsr166e/Striped64.java?revision=1.6</a></p>

<p>Class holding common representation and mechanics for classes supporting
dynamic striping on 64bit values.</p>

<p>This class maintains a lazily-initialized table of atomically updated
variables, plus an extra <code>base</code> field. The table size is a power
of two. Indexing uses masked per-thread hash codes. Nearly all methods on
this class are private, accessed directly by subclasses.</p>

<p>Table entries are of class <code>Cell</code>; a variant of AtomicLong
padded to reduce cache contention on most processors. Padding is overkill
for most Atomics because they are usually irregularly scattered in memory
and thus don&#39;t interfere much with each other. But Atomic objects
residing in arrays will tend to be placed adjacent to each other, and so
will most often share cache lines (with a huge negative performance impact)
without this precaution.</p>

<p>In part because +Cell+s are relatively large, we avoid creating them until
they are needed. When there is no contention, all updates are made to the
<code>base</code> field. Upon first contention (a failed CAS on
<code>base</code> update), the table is initialized to size 2. The table
size is doubled upon further contention until reaching the nearest power of
two greater than or equal to the number of CPUS. Table slots remain empty
(<code>nil</code>) until they are needed.</p>

<p>A single spinlock (<code>busy</code>) is used for initializing and resizing
the table, as well as populating slots with new +Cell+s. There is no need
for a blocking lock: When the lock is not available, threads try other
slots (or the base). During these retries, there is increased contention
and reduced locality, which is still better than alternatives.</p>

<p>Per-thread hash codes are initialized to random values. Contention and/or
table collisions are indicated by failed CASes when performing an update
operation (see method <code>retry_update</code>). Upon a collision, if the
table size is less than the capacity, it is doubled in size unless some
other thread holds the lock. If a hashed slot is empty, and lock is
available, a new <code>Cell</code> is created. Otherwise, if the slot
exists, a CAS is tried. Retries proceed by “double hashing”, using a
secondary hash (XorShift) to try to find a free slot.</p>

<p>The table size is capped because, when there are more threads than CPUs,
supposing that each thread were bound to a CPU, there would exist a perfect
hash function mapping threads to slots that eliminates collisions. When we
reach capacity, we search for this mapping by randomly varying the hash
codes of colliding threads. Because search is random, and collisions only
become known via CAS failures, convergence can be slow, and because threads
are typically not bound to CPUS forever, may not occur at all. However,
despite these limitations, observed contention rates are typically low in
these cases.</p>

<p>It is possible for a <code>Cell</code> to become unused when threads that
once hashed to it terminate, as well as in the case where doubling the
table causes no thread to hash to it under expanded mask. We do not try to
detect or remove such cells, under the assumption that for long-running
instances, observed contention levels will recur, so the cells will
eventually be needed again; and for short-lived ones, it does not matter.</p>

<p>@!visibility private</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="THREAD_LOCAL_KEY">THREAD_LOCAL_KEY
        
        <dd class="description"><p>Static per-thread hash code key. Shared across all instances to reduce
Thread locals pollution and because adjustments due to collisions in one
table are likely to be appropriate for others.</p>
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 107</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>
  <span class="ruby-keyword">super</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">busy</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">base</span> = <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-retry_update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">retry_update</span><span
            class="method-args">(x, hash_code, was_uncontended) { |current_value| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Handles cases of updates involving initialization, resizing, creating new
Cells, and/or contention. See above for explanation. This method suffers
the usual non-modularity problems of optimistic retry code, relying on
rechecked sets of reads.</p>

<p>Arguments:</p>
<dl class="rdoc-list label-list"><dt><code>x</code>
<dd>
<p>the value</p>
</dd><dt><code>hash_code</code>
<dd>
<p>hash code used</p>
</dd><dt><code>x</code>
<dd>
<p>false if CAS failed before call</p>
</dd></dl>
          
          

          
          <div class="method-source-code" id="retry_update-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">retry_update</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">hash_code</span>, <span class="ruby-identifier">was_uncontended</span>) <span class="ruby-comment"># :yields: current_value</span>
  <span class="ruby-identifier">hash</span>     = <span class="ruby-identifier">hash_code</span>
  <span class="ruby-identifier">collided</span> = <span class="ruby-keyword">false</span> <span class="ruby-comment"># True if last slot nonempty</span>
  <span class="ruby-keyword">while</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_cells</span> = <span class="ruby-identifier">cells</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">cell</span> = <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">volatile_get_by_hash</span>(<span class="ruby-identifier">hash</span>))
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">busy?</span>
          <span class="ruby-identifier">collided</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">else</span> <span class="ruby-comment"># Try to attach new Cell</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">try_to_install_new_cell</span>(<span class="ruby-constant">Cell</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">x</span>), <span class="ruby-identifier">hash</span>) <span class="ruby-comment"># Optimistically create and try to insert new cell</span>
            <span class="ruby-keyword">break</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">redo</span> <span class="ruby-comment"># Slot is now non-empty</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">was_uncontended</span> <span class="ruby-comment"># CAS already known to fail</span>
        <span class="ruby-identifier">was_uncontended</span> = <span class="ruby-keyword">true</span> <span class="ruby-comment"># Continue after rehash</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">cas_computed</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">current_value</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">current_value</span>}
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-constant">CPU_COUNT</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cells</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_cells</span> <span class="ruby-comment"># At max size or stale</span>
        <span class="ruby-identifier">collided</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">collided</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">expand_table_unless_stale</span>(<span class="ruby-identifier">current_cells</span>)
        <span class="ruby-identifier">collided</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">redo</span> <span class="ruby-comment"># Retry with expanded table</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">collided</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">hash</span> = <span class="ruby-constant">XorShiftRandom</span>.<span class="ruby-identifier">xorshift</span>(<span class="ruby-identifier">hash</span>)

    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">try_initialize_cells</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">hash</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">cas_base_computed</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">current_base</span><span class="ruby-operator">|</span> <span class="ruby-keyword">yield</span> <span class="ruby-identifier">current_base</span>}
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hash_code</span> = <span class="ruby-identifier">hash</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- retry_update-source -->
          
        </div>

        

        
      </div><!-- retry_update-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="private-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Private Instance Methods</h3>

    
      <div id="method-i-cas_base_computed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cas_base_computed</span><span
            class="method-args">() { |current_base| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cas_base_computed-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 190</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cas_base_computed</span>
  <span class="ruby-identifier">cas_base</span>(<span class="ruby-identifier">current_base</span> = <span class="ruby-identifier">base</span>, <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">current_base</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- cas_base_computed-source -->
          
        </div>

        

        
      </div><!-- cas_base_computed-method -->

    
      <div id="method-i-expand_table_unless_stale" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">expand_table_unless_stale</span><span
            class="method-args">(current_cells)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="expand_table_unless_stale-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 210</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">expand_table_unless_stale</span>(<span class="ruby-identifier">current_cells</span>)
  <span class="ruby-identifier">try_in_busy</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_cells</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cells</span> <span class="ruby-comment"># Recheck under lock</span>
      <span class="ruby-identifier">new_cells</span> = <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">next_in_size_table</span>
      <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">each_with_index</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">x</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">new_cells</span>.<span class="ruby-identifier">volatile_set</span>(<span class="ruby-identifier">i</span>, <span class="ruby-identifier">x</span>)}
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cells</span> = <span class="ruby-identifier">new_cells</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- expand_table_unless_stale-source -->
          
        </div>

        

        
      </div><!-- expand_table_unless_stale-method -->

    
      <div id="method-i-free-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">free?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="free-3F-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">free?</span>
  <span class="ruby-operator">!</span><span class="ruby-identifier">busy?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- free-3F-source -->
          
        </div>

        

        
      </div><!-- free-3F-method -->

    
      <div id="method-i-hash_code" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hash_code</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A thread-local hash code accessor. The code is initially random, but may be
set to a different value upon collisions.</p>
          
          

          
          <div class="method-source-code" id="hash_code-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 171</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hash_code</span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">THREAD_LOCAL_KEY</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">XorShiftRandom</span>.<span class="ruby-identifier">get</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- hash_code-source -->
          
        </div>

        

        
      </div><!-- hash_code-method -->

    
      <div id="method-i-hash_code-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hash_code=</span><span
            class="method-args">(hash)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="hash_code-3D-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 175</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hash_code=</span>(<span class="ruby-identifier">hash</span>)
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-constant">THREAD_LOCAL_KEY</span>] = <span class="ruby-identifier">hash</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- hash_code-3D-source -->
          
        </div>

        

        
      </div><!-- hash_code-3D-method -->

    
      <div id="method-i-internal_reset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">internal_reset</span><span
            class="method-args">(initial_value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Sets base and all <code>cells</code> to the given value.</p>
          
          

          
          <div class="method-source-code" id="internal_reset-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 180</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">internal_reset</span>(<span class="ruby-identifier">initial_value</span>)
  <span class="ruby-identifier">current_cells</span> = <span class="ruby-identifier">cells</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">base</span>     = <span class="ruby-identifier">initial_value</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_cells</span>
    <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cell</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cell</span>.<span class="ruby-identifier">value</span> = <span class="ruby-identifier">initial_value</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cell</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- internal_reset-source -->
          
        </div>

        

        
      </div><!-- internal_reset-method -->

    
      <div id="method-i-try_in_busy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_in_busy</span><span
            class="method-args">() { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="try_in_busy-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 229</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_in_busy</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">cas_busy</span>(<span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>)
    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">yield</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">busy</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- try_in_busy-source -->
          
        </div>

        

        
      </div><!-- try_in_busy-method -->

    
      <div id="method-i-try_initialize_cells" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_initialize_cells</span><span
            class="method-args">(x, hash)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="try_initialize_cells-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 198</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_initialize_cells</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">hash</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">free?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">cells</span>
    <span class="ruby-identifier">try_in_busy</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cells</span> <span class="ruby-comment"># Recheck under lock</span>
        <span class="ruby-identifier">new_cells</span> = <span class="ruby-constant">PowerOfTwoTuple</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">2</span>)
        <span class="ruby-identifier">new_cells</span>.<span class="ruby-identifier">volatile_set_by_hash</span>(<span class="ruby-identifier">hash</span>, <span class="ruby-constant">Cell</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">x</span>))
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cells</span> = <span class="ruby-identifier">new_cells</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- try_initialize_cells-source -->
          
        </div>

        

        
      </div><!-- try_initialize_cells-method -->

    
      <div id="method-i-try_to_install_new_cell" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">try_to_install_new_cell</span><span
            class="method-args">(new_cell, hash)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="try_to_install_new_cell-source">
            <pre><span class="ruby-comment"># File lib/concurrent/thread_safe/util/striped64.rb, line 220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_to_install_new_cell</span>(<span class="ruby-identifier">new_cell</span>, <span class="ruby-identifier">hash</span>)
  <span class="ruby-identifier">try_in_busy</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># Recheck under lock</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">current_cells</span> = <span class="ruby-identifier">cells</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">volatile_get</span>(<span class="ruby-identifier">i</span> = <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">hash_to_index</span>(<span class="ruby-identifier">hash</span>))
      <span class="ruby-identifier">current_cells</span>.<span class="ruby-identifier">volatile_set</span>(<span class="ruby-identifier">i</span>, <span class="ruby-identifier">new_cell</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- try_to_install_new_cell-source -->
          
        </div>

        

        
      </div><!-- try_to_install_new_cell-method -->

    
    </section><!-- private-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 4.0.0.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

